import os
import ROOT
import json
from lzt_utils.root import rdf_to_pandas
import pandas as pd
from pathlib import Path
from typing import Union

FILE_DIRECTORIES = [
    'EVT',
    'HIT',
    'ESD',
    'AOD',
    'NTUPLE'
]


class LztDataset:
    """
    Class for managing the dataset directories generated by lorenzetti

    Attributes
    ----------
    path : str
        Path to the dataset directory
    basename : str
        Basename of the dataset files
    label : str, optional
        Dataset label, useful for plotting, by default None

    Properties
    ----------
    evt_path : str
        Path to the EVT directory
    hit_path : str
        Path to the HIT directory
    esd_path : str
        Path to the ESD directory
    aod_path : str
        Path to the AOD directory
    ntuple_path : str
        Path to the NTUPLE directory
    """
    def __init__(self,
                 path: Union[str, Path],
                 basename: str,
                 label: str = None,
                 **kwargs):
        """
        Parameters
        ----------
        path : str
            Path to the dataset directory
        basename : str
            Basename of the dataset files
        label : str, optional
            Dataset label, useful for plotting, by default None
        """
        if isinstance(path, str):
            self.path = Path(path)
        self.path = path
        self.basename = basename
        self.label = label

    def __repr__(self) -> str:
        repr_str = f'LztDataset(path={self.path}, label={self.label})'
        return repr_str

    @property
    def evt_path(self) -> Path:
        return self.path / 'EVT'

    @property
    def hit_path(self) -> Path:
        return self.path / 'HIT'

    @property
    def esd_path(self) -> Path:
        return self.path / 'ESD'

    @property
    def aod_path(self) -> Path:
        return self.path / 'AOD'

    @property
    def ntuple_path(self) -> Path:
        return self.path / 'NTUPLE'

    def get_ntuple_rdf(self) -> ROOT.RDataFrame:
        """
        Get the RDataFrame for the ntuple files

        Returns
        -------
        ROOT.RDataFrame
            RDataFrame for the ntuple
        """
        ntuple_files = [str(filename) for filename
                        in self.ntuple_path.glob('*.root')]
        print(f'NTUPLE_FILES: {ntuple_files}')
        rdf = ROOT.RDataFrame("events", ntuple_files)
        return rdf

    def get_ntuple_pdf(self) -> pd.DataFrame:
        """
        Get the pandas DataFrame for the ntuple files

        Returns
        -------
        pd.DataFrame
            DataFrame for the ntuple
        """
        return rdf_to_pandas(self.get_ntuple_rdf())

    def makedirs(self, directory: str) -> Path:
        """
        Create a directory inside the dataset directory

        Parameters
        ----------
        directory : str
            Directory name

        Returns
        -------
        Path
            Absolute path to the created directory
        """
        dir_path = self.path / directory
        dir_path.mkdir(parents=True, exist_ok=True)
        return dir_path.resolve()

    @classmethod
    def from_dir(cls, path: str):
        """
        Create a LztDataset object from a directory

        Parameters
        ----------
        path : str
            Path to the dataset directory

        Returns
        -------
        LztDataset
            LztDataset object

        Raises
        ------
        ValueError
            If the path is not a directory
        """
        if os.path.isdir(path):
            with open(os.path.join(path, 'dataset_info.json'), 'r') as f:
                data = json.load(f)
                return cls(path, **data)
        else:
            raise ValueError(f'{path} is not a directory')
